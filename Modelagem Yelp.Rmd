---
title: "Integradora Yelp"
author: "Viviane Sanchez"
date: "6/27/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}

library(tidyverse)
library(tidymodels)
library(tidytext)
library(skimr)
library(ggrepel)
library(ggdendro)
library(factoextra)
library(vip)
library(doParallel)
library(vegan)
library(leaps)

```


## Leitura de arquivos

```{r eval=FALSE, include=FALSE}

yelp_raw <- list.files(path = 'output/yelp.csv/', 
                       pattern = "*.csv",
                       full.names = TRUE) %>% 
            map_df(~read_csv(.))


yelp_dist_raw <- list.files(path = 'output/yelp_dist.csv/', 
                       pattern = "*.csv",
                       full.names = TRUE) %>% 
            map_df(~read_csv(.))


```

## yelp - dist

```{r}


yelp_euc <- yelp_dist_raw %>%
        select(-user_id) %>% 
        mutate_all(~replace(., is.na(.), 0)) %>% 
        as.matrix()

euc_hclust <- (hclust(get_dist(yelp_jaccard, method = 'binary')))

view(yelp_dist_raw)

yelp_jaccard <- yelp_dist_raw %>%
        select(-user_id) %>% 
        mutate_all(~replace(., is.na(.), 0)) %>% 
        mutate_all(., ~replace(. >= 3, 1,0)) %>% 
        #mutate(user_id = yelp_dist_raw$user_id) %>% 
        as.matrix()

get_dist(yelp_jaccard, method = 'binary')

yelp_hclust <- hclust(get_dist(yelp_jaccard, method = 'binary'))

```



```{r}

plot(yelp_hclust, main = "Yelp",
     xlab = "", ylab = "", sub = , cex = 1.5)

yelp_hclust$order

# install.packages("ggdendro")

library(ggdendro)

ggdendrogram(hc, rotate = TRUE, labels = TRUE) +
    labs(title = "Mercado de Scotch Whisky")


```

## hclust


```{r}

yelp_matrix <- yelp_juice %>% 
  drop_na() %>% 
  select(-user_id, -business_id, -name_bz, -date, -yelping_since) %>% 
  as.matrix()

kclust <- kmeans(yelp_matrix, 5)

summary(kclust)

kclusts <- 
  tibble(k = 1:9) %>%
  mutate(
    kclust = map(k, ~kmeans(yelp_matrix, .x)),
    tidied = map(kclust, tidy),
    glanced = map(kclust, glance),
    augmented = map(kclust, augment, points)
  )

```


```{r}

    yelp_hclust <- yelp_matrix %>%
        get_dist(method = "euclidean")
    
        #hclust(method = "complete")

    
       yelp_hclust <- yelp_juice %>%
        select(-user_id, -business_id, -date, -yelping_since) %>% 
        get_dist(method = "manhattan") %>%  
        hclust(method = "complete")


```




## Yelp - base completa 

```{r}

skim(yelp_raw)

yelp <- yelp_raw %>% 
        mutate(yelping_since = as.Date(yelping_since),
         date = as.Date(date))
  

skim(yelp)

```


```{r}

yelp %>% 
  ggplot(aes(longitude, latitude, color = stars)) +
  geom_point(size = 0.5, alpha = 0.7) +
  scale_color_gradient(low = 'skyblue', high = 'darkred', labels = scales::label_number_si()) +
  labs(title = 'Review Stars')


```


## Latitude vs Longitude

```{r}

gg_lat_lon <- function(col_ref, title_string){
      yelp %>% 
        ggplot(aes(longitude, latitude, color = col_ref)) +
        geom_point(size = 0.5, alpha = 0.7) +
        scale_color_gradient(low = 'skyblue', high = 'darkred', labels = scales::label_number_si()) +
        labs(title = title_string)
}

```

```{r}

gg_lat_lon(yelp$stars_usr, 'Average Stars by user')

```

```{r}

gg_lat_lon(yelp$stars, 'Review Stars')

```

```{r}

gg_lat_lon(yelp$stars_bz, 'Average Stars by Business')

```

```{r}

gg_lat_lon(yelp$review_count, 'Review count by Business')

```


## Split

```{r}

split <- initial_split(yelp, prop = 0.8)

train <- training(split)
test <- testing(split)

```


## Recipe

```{r}

rec <- recipe( ~ ., train) %>% 
  update_role(business_id, user_id, name_bz, new_role = 'id') %>% 
  step_date(date, yelping_since, features = c("dow", "month","year")) %>% 
  step_other(categories, threshold = 0.005) %>% 
  step_other(postal_code, threshold = 0.01) %>% 
  step_dummy(all_nominal(), -'business_id',-'user_id',-'name_bz') %>%
  step_normalize(all_numeric()) %>% 
  step_naomit(all_predictors())

yelp_juice <- juice(prep(rec))

skim(yelp_juice)

```



## PCA

```{r}

rec_pca <- recipe( ~ ., train) %>% 
  update_role(business_id, user_id, name_bz, new_role = 'id') %>% 
  step_date(date, yelping_since, features = c("dow", "month","year")) %>% 
  #step_other(categories, threshold = 0.005) %>% 
  #step_other(postal_code, threshold = 0.01) %>% 
  #step_dummy(all_nominal(), -'business_id',-'user_id',-'name_bz') %>%
  step_normalize(all_numeric()) %>% 
  step_pca(all_numeric()) %>% 
  step_naomit(all_predictors()) %>% 
  prep()


yelp_pca <- juice(rec_pca)

skim(yelp_pca)

#pca_train  <- juice(rec_pca) 

rec_pca$steps[[3]]$res

  
```


### Scree Plot

```{r}

variance_pct <- rec_pca$steps[[3]]$res

(cumsum(variance_pct$sdev^2) / sum(variance_pct$sdev^2))

fviz_eig(variance_pct, addlabels = TRUE) + 
  labs(x = "Componente Principal",
       y = "Percentual explicado da variância")

```

### Componentes Principais

```{r}

tidy_pca <- tidy(rec_pca, 3)

tidy_pca %>% 
  filter(component %in% paste0("PC", 1:5)) %>%
  mutate(component = fct_inorder(component)) %>%
  ggplot(aes(value, terms, fill = terms)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~component) +
  labs(y = NULL)

```


### Principais contribuições

```{r}

tidy_pca %>%
  filter(component %in% paste0("PC", 1:5)) %>%
  group_by(component) %>%
  top_n(8, abs(value)) %>%
  ungroup() %>%
  mutate(terms = reorder_within(terms, abs(value), component)) %>%
  ggplot(aes(abs(value), terms, fill = value > 0)) +
  geom_col() +
  facet_wrap(~component, scales = "free_y") +
  scale_y_reordered() +
  labs(
    x = "Valor absoluto da contribuição",
    y = NULL, fill = "Positiva?")

```


## Contrastes

```{r}

variance_pct %>% 
  fviz_pca_var(axes = c(1,2), col.var="contrib", gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"))

```


## Referências

- Neumann, D. Material de aula do cursos Big Data e Computação em Nuvem
- Mendonça, T. Material de aula do curso Modelagem Preditiva Avançada
- [Fernandez, P. Marques. P. Data Science, Marketing and Business](https://datascience.insper.edu.br/datascience.pdf)
- [Rahimi, S.; Mottahedi, S.; Liu, X. The Geography of Taste: Using Yelp to Study Urban Culture. ISPRS Int. J. Geo-Inf. 2018, 7, 376.](https://www.mdpi.com/2220-9964/7/9/376?type=check_update&version=1)




